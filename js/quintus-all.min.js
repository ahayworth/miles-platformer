/*! Quintus - v0.1.4 - 2013-05-05
 *  http://html5quintus.com
 *  Copyright (c) 2013 Pascal Rettig; Licensed MIT, GPLv2 */
var Quintus=function Quintus(t){var e=function(t,i,n){return e.select(t,i,n)};e.select=function(){},e.include=function(t){return e._each(e._normalizeArg(t),function(t){var i=Quintus[t]||t;if(!e._isFunction(i))throw"Invalid Module:"+t;i(e)}),e},e._normalizeArg=function(t){return e._isString(t)&&(t=t.replace(/\s+/g,"").split(",")),e._isArray(t)||(t=[t]),t},e._extend=function(t,e){if(!e)return t;for(var i in e)t[i]=e[i];return t},e._clone=function(t){return e._extend({},t)},e._defaults=function(t,e){if(!e)return t;for(var i in e)void 0===t[i]&&(t[i]=e[i]);return t},e._has=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e._isString=function(t){return"string"==typeof t},e._isNumber=function(t){return"[object Number]"===Object.prototype.toString.call(t)},e._isFunction=function(t){return"[object Function]"===Object.prototype.toString.call(t)},e._isObject=function(t){return"[object Object]"===Object.prototype.toString.call(t)},e._isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},e._isUndefined=function(t){return void 0===t},e._popProperty=function(t,e){var i=t[e];return delete t[e],i},e._each=function(t,e,i){if(null!=t)if(t.forEach)t.forEach(e,i);else if(t.length===+t.length)for(var n=0,s=t.length;s>n;n++)e.call(i,t[n],n,t);else for(var o in t)e.call(i,t[o],o,t)},e._invoke=function(t,e,i,n){if(null!=t)for(var s=0,o=t.length;o>s;s++)t[s][e](i,n)},e._detect=function(t,e,i,n,s){var o;if(null!=t){if(t.length===+t.length){for(var r=0,a=t.length;a>r;r++)if(o=e.call(i,t[r],r,n,s))return o;return!1}for(var h in t)if(o=e.call(i,t[h],h,n,s))return o;return!1}},e._map=function(t,i,n){var s=[];return null==t?s:t.map?t.map(i,n):(e._each(t,function(t,e,o){s[s.length]=i.call(n,t,e,o)}),t.length===+t.length&&(s.length=t.length),s)},e._uniq=function(t){t=t.slice().sort();for(var e=[],i=null,n=0;t.length>n;n++)void 0!==t[n]&&i!==t[n]&&e.push(t[n]),i=t[n];return e},e._shuffle=function(t){var i,n=[];return e._each(t,function(t,e){i=Math.floor(Math.random()*(e+1)),n[e]=n[i],n[i]=t}),n},e._keys=Object.keys||function(t){if(e._isObject(t))throw new TypeError("Invalid object");var i=[];for(var n in t)e._has(t,n)&&(i[i.length]=n);return i},e._range=function(t,e,i){i=i||1;for(var n=Math.max(Math.ceil((e-t)/i),0),s=0,o=Array(n);n>s;)o[s++]=t,t+=i;return o};var i=0;return e._uniqueId=function(){return i++},e.options={imagePath:"images/",audioPath:"audio/",dataPath:"data/",audioSupported:["mp3","ogg"],sound:!0,frameTimeLimit:100},t&&e._extend(e.options,t),e.gameLoop=function(t){return e.lastGameLoopFrame=(new Date).getTime(),e.loop=!0,e._loopFrame=0,e.gameLoopCallbackWrapper=function(){var i=(new Date).getTime();e._loopFrame++,e.loop=window.requestAnimationFrame(e.gameLoopCallbackWrapper);var n=i-e.lastGameLoopFrame;n>e.options.frameTimeLimit&&(n=e.options.frameTimeLimit),t.apply(e,[n/1e3]),e.lastGameLoopFrame=i},window.requestAnimationFrame(e.gameLoopCallbackWrapper),e},e.pauseGame=function(){e.loop&&window.cancelAnimationFrame(e.loop),e.loop=null},e.unpauseGame=function(){e.loop||(e.lastGameLoopFrame=(new Date).getTime(),e.loop=window.requestAnimationFrame(e.gameLoopCallbackWrapper))},function(){var t=!1,i=/xyz/.test(function(){})?/\b_super\b/:/.*/;e.Class=function(){},e.Class.prototype.isA=function(t){return this.className===t},e.Class.extend=function(n,s,o){function r(t,e){return function(){var i=this._super;this._super=h[t];var n=e.apply(this,arguments);return this._super=i,n}}function a(){!t&&this.init&&this.init.apply(this,arguments)}e._isString(n)||(o=s,s=n,n=null);var h=this.prototype,l=this;t=!0;var c=new l;t=!1;for(var u in s)c[u]="function"==typeof s[u]&&"function"==typeof h[u]&&i.test(s[u])?r(u,s[u]):s[u];return a.prototype=c,a.prototype.constructor=a,a.extend=e.Class.extend,o&&e._extend(a,o),n&&(e[n]=a,a.prototype.className=n,a.className=n),a}}(),e.Class.extend("Evented",{on:function(t,i,n){if(e._isArray(t)||-1!==t.indexOf(",")){t=e._normalizeArg(t);for(var s=0;t.length>s;s++)this.on(t[s],i,n)}else n||(n=i,i=null),n||(n=t),e._isString(n)&&(n=(i||this)[n]),this.listeners=this.listeners||{},this.listeners[t]=this.listeners[t]||[],this.listeners[t].push([i||this,n]),i&&(i.binds||(i.binds=[]),i.binds.push([this,t,n]))},trigger:function(t,e){if(this.listeners&&this.listeners[t])for(var i=0,n=this.listeners[t].length;n>i;i++){var s=this.listeners[t][i];s[1].call(s[0],e)}},off:function(t,i,n){if(i){e._isString(n)&&i[n]&&(n=i[n]);var s=this.listeners&&this.listeners[t];if(s)for(var o=s.length-1;o>=0;o--)s[o][0]===i&&(n&&n!==s[o][1]||this.listeners[t].splice(o,1))}else this.listeners[t]&&delete this.listeners[t]},debind:function(){if(this.binds)for(var t=0,e=this.binds.length;e>t;t++){var i=this.binds[t],n=i[0],s=i[1];n.off(s,this)}}}),e.components={},e.Evented.extend("Component",{init:function(t){this.entity=t,this.extend&&e._extend(t,this.extend),t[this.name]=this,t.activeComponents.push(this.componentName),t.stage&&t.stage.addToList&&t.stage.addToList(this.componentName,t),this.added&&this.added()},destroy:function(){if(this.extend)for(var t=e._keys(this.extend),i=0,n=t.length;n>i;i++)delete this.entity[t[i]];delete this.entity[this.name];var s=this.entity.activeComponents.indexOf(this.componentName);-1!==s&&(this.entity.activeComponents.splice(s,1),this.entity.stage&&this.entity.stage.addToList&&this.entity.stage.addToLists(this.componentName,this.entity)),this.debind(),this.destroyed&&this.destroyed()}}),e.Evented.extend("GameObject",{has:function(t){return this[t]?!0:!1},add:function(t){t=e._normalizeArg(t),this.activeComponents||(this.activeComponents=[]);for(var i=0,n=t.length;n>i;i++){var s=t[i],o=e.components[s];if(!this.has(s)&&o){var r=new o(this);this.trigger("addComponent",r)}}return this},del:function(t){t=e._normalizeArg(t);for(var i=0,n=t.length;n>i;i++){var s=t[i];s&&this.has(s)&&(this.trigger("delComponent",this[s]),this[s].destroy())}return this},destroy:function(){this.isDestroyed||(this.trigger("destroyed"),this.debind(),this.stage&&this.stage.remove&&this.stage.remove(this),this.isDestroyed=!0,this.destroyed&&this.destroyed())}}),e.component=function(t,i){return i?(i.name=t,i.componentName="."+t,e.components[t]=e.Component.extend(t+"Component",i)):e.components[t]},e.GameObject.extend("GameState",{init:function(t){this.p=e._extend({},t),this.listeners={}},reset:function(t){this.init(t),this.trigger("reset")},_triggerProperty:function(t,e){this.p[e]!==t&&(this.p[e]=t,this.trigger("change."+e,t))},set:function(t,i){e._isObject(t)?e._each(t,this._triggerProperty,this):this._triggerProperty(i,t),this.trigger("change")},inc:function(t,e){this.set(t,this.get(t)+e)},dec:function(t,e){this.set(t,this.get(t)-e)},get:function(t){return this.p[t]}}),e.state=new e.GameState,e.reset=function(){e.state.reset()},e.touchDevice="ontouchstart"in document,e.setup=function(t,i){e._isObject(t)&&(i=t,t=null),i=i||{},t=t||"quintus",e.el=e._isString(t)?document.getElementById(t):t,e.el||(e.el=document.createElement("canvas"),e.el.width=i.width||320,e.el.height=i.height||420,e.el.id=t,document.body.appendChild(e.el));var n=parseInt(e.el.width,10),s=parseInt(e.el.height,10),o=i.maxWidth||5e3,r=i.maxHeight||5e3,a=i.resampleWidth,h=i.resampleHeight,l=i.upsampleWidth,c=i.upsampleHeight;i.maximize===!0||e.touchDevice&&"touch"===i.maximize?(document.body.style.padding=0,document.body.style.margin=0,n=Math.min(window.innerWidth,o),s=Math.min(window.innerHeight-5,r),e.touchDevice&&(e.el.style.height=2*s+"px",window.scrollTo(0,1),n=Math.min(window.innerWidth,o),s=Math.min(window.innerHeight,r))):e.touchDevice&&window.scrollTo(0,1),l&&l>=n||c&&c>=s?(e.el.style.height=s+"px",e.el.style.width=n+"px",e.el.width=2*n,e.el.height=2*s):(a&&n>a||h&&s>h)&&e.touchDevice?(e.el.style.height=s+"px",e.el.style.width=n+"px",e.el.width=n/2,e.el.height=s/2):(e.el.style.height=s+"px",e.el.style.width=n+"px",e.el.width=n,e.el.height=s);var u=e.el.parentNode;return u&&(e.wrapper=document.createElement("div"),e.wrapper.id=t+"_container",e.wrapper.style.width=n+"px",e.wrapper.style.margin="0 auto",e.wrapper.style.position="relative",u.insertBefore(e.wrapper,e.el),e.wrapper.appendChild(e.el)),e.el.style.position="relative",e.ctx=e.el.getContext&&e.el.getContext("2d"),e.width=parseInt(e.el.width,10),e.height=parseInt(e.el.height,10),e.cssWidth=n,e.cssHeight=s,window.addEventListener("orientationchange",function(){setTimeout(function(){window.scrollTo(0,1)},0)}),e},e.clear=function(){e.clearColor?(e.ctx.globalAlpha=1,e.ctx.fillStyle=e.clearColor,e.ctx.fillRect(0,0,e.width,e.height)):e.ctx.clearRect(0,0,e.width,e.height)},e.imageData=function(t){var e=document.createElement("canvas");e.width=t.width,e.height=t.height;var i=e.getContext("2d");return i.drawImage(t,0,0),i.getImageData(0,0,t.width,t.height)},e.assetTypes={png:"Image",jpg:"Image",gif:"Image",jpeg:"Image",ogg:"Audio",wav:"Audio",m4a:"Audio",mp3:"Audio"},e.assetType=function(t){var i=t.split("."),n=i[i.length-1].toLowerCase(),s=e.assetTypes[n];return"Audio"===s&&e.audio&&"WebAudio"===e.audio.type&&(s="WebAudio"),s||"Other"},e.assetUrl=function(t,e){return/^https?:\/\//.test(e)||"/"===e[0]?e:t+e},e.loadAssetImage=function(t,i,n,s){var o=new Image;o.onload=function(){n(t,o)},o.onerror=s,o.src=e.assetUrl(e.options.imagePath,i)},e.audioMimeTypes={mp3:"audio/mpeg",ogg:'audio/ogg; codecs="vorbis"',m4a:"audio/m4a",wav:"audio/wav"},e._audioAssetExtension=function(){if(e._audioAssetPreferredExtension)return e._audioAssetPreferredExtension;var t=new Audio;return e._audioAssetPreferredExtension=e._detect(e.options.audioSupported,function(i){return t.canPlayType(e.audioMimeTypes[i])?i:null})},e.loadAssetAudio=function(t,i,n,s){if(!document.createElement("audio").play||!e.options.sound)return n(t,null),void 0;var o=e._removeExtension(i),r=e._audioAssetExtension(),a=new Audio;return r?(a.addEventListener("error",s),e.touchDevice||a.addEventListener("canplaythrough",function(){n(t,a)}),a.src=e.assetUrl(e.options.audioPath,o+"."+r),a.load(),e.touchDevice&&n(t,a),void 0):(n(t,null),void 0)},e.loadAssetWebAudio=function(t,i,n,s){var o=new XMLHttpRequest,r=e._removeExtension(i),a=e._audioAssetExtension();o.open("GET",e.assetUrl(e.options.audioPath,r+"."+a),!0),o.responseType="arraybuffer",o.onload=function(){o.response,e.audioContext.decodeAudioData(o.response,function(e){n(t,e)},s)},o.send()},e.loadAssetOther=function(t,i,n,s){var o=new XMLHttpRequest,r=i.split("."),a=r[r.length-1].toLowerCase();o.onreadystatechange=function(){4===o.readyState&&(200===o.status?"json"===a?n(t,JSON.parse(o.responseText)):n(t,o.responseText):s())},o.open("GET",e.options.dataPath+i,!0),o.send(null)},e._removeExtension=function(t){return t.replace(/\.(\w{3,4})$/,"")},e.assets={},e.asset=function(t){return e.assets[t]},e.load=function(t,i,n){var s={};n||(n={});var o=n.progressCallback,r=!1,a=function(t){r=!0,(n.errorCallback||function(t){throw"Error Loading: "+t})(t)};e._isString(t)&&(t=e._normalizeArg(t)),e._isArray(t)?e._each(t,function(t){e._isObject(t)?e._extend(s,t):s[t]=t}):s=t;var h=e._keys(s).length,l=h,c=function(t,n,s){r||((!e.assets[t]||s)&&(e.assets[t]=n,l--,o&&o(h-l,h)),0===l&&i&&i.apply(e))};e._each(s,function(t,i){var n=e.assetType(t);e.assets[i]?c(i,e.assets[i],!0):e["loadAsset"+n](i,t,c,function(){a(t)})})},e.preloads=[],e.preload=function(t,i){e._isFunction(t)?(e.load(e._uniq(e.preloads),t,i),e.preloads=[]):e.preloads=e.preloads.concat(t)},e.matrices2d=[],e.matrix2d=function(){return e.matrices2d.length>0?e.matrices2d.pop().identity():new e.Matrix2D},e.Matrix2D=e.Class.extend({init:function(t){t?(this.m=[],this.clone(t)):this.m=[1,0,0,0,1,0]},identity:function(){var t=this.m;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,this},clone:function(t){var e=this.m,i=t.m;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],this},multiply:function(t){var e=this.m,i=t.m,n=e[0]*i[0]+e[1]*i[3],s=e[0]*i[1]+e[1]*i[4],o=e[0]*i[2]+e[1]*i[5]+e[2],r=e[3]*i[0]+e[4]*i[3],a=e[3]*i[1]+e[4]*i[4],h=e[3]*i[2]+e[4]*i[5]+e[5];return e[0]=n,e[1]=s,e[2]=o,e[3]=r,e[4]=a,e[5]=h,this},rotate:function(t){if(0===t)return this;var e=Math.cos(t),i=Math.sin(t),n=this.m,s=n[0]*e+n[1]*i,o=n[0]*-i+n[1]*e,r=n[3]*e+n[4]*i,a=n[3]*-i+n[4]*e;return n[0]=s,n[1]=o,n[3]=r,n[4]=a,this},rotateDeg:function(t){return 0===t?this:this.rotate(Math.PI*t/180)},scale:function(t,e){var i=this.m;return void 0===e&&(e=t),i[0]*=t,i[1]*=e,i[3]*=t,i[4]*=e,this},translate:function(t,e){var i=this.m;return i[2]+=i[0]*t+i[1]*e,i[5]+=i[3]*t+i[4]*e,this},transform:function(t,e){return[t*this.m[0]+e*this.m[1]+this.m[2],t*this.m[3]+e*this.m[4]+this.m[5]]},transformPt:function(t){var e=t.x,i=t.y;return t.x=e*this.m[0]+i*this.m[1]+this.m[2],t.y=e*this.m[3]+i*this.m[4]+this.m[5],t},transformArr:function(t,e){var i=t[0],n=t[1];return e[0]=i*this.m[0]+n*this.m[1]+this.m[2],e[1]=i*this.m[3]+n*this.m[4]+this.m[5],e},transformX:function(t,e){return t*this.m[0]+e*this.m[1]+this.m[2]},transformY:function(t,e){return t*this.m[3]+e*this.m[4]+this.m[5]},release:function(){return e.matrices2d.push(this),null},setContextTransform:function(t){var e=this.m;t.transform(e[0],e[3],e[1],e[4],e[2],e[5])}}),e};(function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;e.length>i&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e){var i=(new Date).getTime(),n=Math.max(0,16-(i-t)),s=window.setTimeout(function(){e(i+n)},n);return t=i+n,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})})(),Quintus["2D"]=function(t){t.component("viewport",{added:function(){this.entity.on("prerender",this,"prerender"),this.entity.on("render",this,"postrender"),this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.centerX=t.width/2,this.centerY=t.height/2,this.scale=1},extend:{follow:function(t,e){this.off("poststep",this.viewport,"follow"),this.viewport.directions=e||{x:!0,y:!0},this.viewport.following=t,this.on("poststep",this.viewport,"follow"),this.viewport.follow(!0)},unfollow:function(){this.off("poststep",this.viewport,"follow")},centerOn:function(t,e){this.viewport.centerOn(t,e)},moveTo:function(t,e){return this.viewport.moveTo(t,e)}},follow:function(e){var i=t._isFunction(this.directions.x)?this.directions.x(this.following):this.directions.x,n=t._isFunction(this.directions.y)?this.directions.y(this.following):this.directions.y;this[e===!0?"centerOn":"softCenterOn"](i?this.following.p.x+this.following.p.w/2-this.offsetX:void 0,n?this.following.p.y+this.following.p.h/2-this.offsetY:void 0)},offset:function(t,e){this.offsetX=t,this.offsetY=e},softCenterOn:function(e,i){void 0!==e&&(this.x+=(e-t.width/2/this.scale-this.x)/3),void 0!==i&&(this.y+=(i-t.height/2/this.scale-this.y)/3)},centerOn:function(e,i){void 0!==e&&(this.x=e-t.width/2/this.scale),void 0!==i&&(this.y=i-t.height/2/this.scale)},moveTo:function(t,e){return void 0!==t&&(this.x=t),void 0!==e&&(this.y=e),this.entity},prerender:function(){this.centerX=this.x+t.width/2/this.scale,this.centerY=this.y+t.height/2/this.scale,t.ctx.save(),t.ctx.translate(Math.floor(t.width/2),Math.floor(t.height/2)),t.ctx.scale(this.scale,this.scale),t.ctx.translate(-Math.floor(this.centerX),-Math.floor(this.centerY))},postrender:function(){t.ctx.restore()}}),t.TileLayer=t.Sprite.extend({init:function(t){this._super(t,{tileW:32,tileH:32,blockTileW:10,blockTileH:10,type:1}),this.p.dataAsset&&this.load(this.p.dataAsset),this.blocks=[],this.p.blockW=this.p.tileW*this.p.blockTileW,this.p.blockH=this.p.tileH*this.p.blockTileH,this.colBounds={},this.directions=["top","left","right","bottom"],this.collisionObject={p:{w:this.p.tileW,h:this.p.tileH,cx:this.p.tileW/2,cy:this.p.tileH/2}},this.collisionNormal={separate:[]}},load:function(e){var i=e.split("."),n=i[i.length-1].toLowerCase();if("json"==n)var s=t._isString(e)?t.asset(e):e;else{if("tmx"!=n&&"xml"!=n)throw"file type not supported";for(var o=new DOMParser,r=o.parseFromString(t.asset(e),"application/xml"),a=r.getElementsByTagName("layer")[0],h=parseInt(a.getAttribute("width")),l=parseInt(a.getAttribute("height")),s=[],c=a.getElementsByTagName("tile"),u=0,p=0;l>p;p++){s[p]=[];for(var d=0;h>d;d++){var f=c[u];s[p].push(parseInt(f.getAttribute("gid")-1)),u++}}}this.p.tiles=s,this.p.rows=s.length,this.p.cols=s[0].length,this.p.w=this.p.rows*this.p.tileH,this.p.h=this.p.cols*this.p.tileW},getTile:function(t,e){return this.p.tiles[e]&&this.p.tiles[e][t]},setTile:function(t,e,i){var n=this.p,s=Math.floor(t/n.blockTileW),o=Math.floor(e/n.blockTileH);s>=0&&o>=0&&this.p.cols>s&&this.p.cols>o&&(this.p.tiles[e][t]=i,this.blocks[o]&&(this.blocks[o][s]=null))},tilePresent:function(t,e){return this.p.tiles[e]&&this.collidableTile(this.p.tiles[e][t])},drawableTile:function(t){return t>0},collidableTile:function(t){return t>0},collide:function(e){var i,n=this.p,s=Math.floor((e.p.x-e.p.cx-n.x)/n.tileW),o=Math.floor((e.p.y-e.p.cy-n.y)/n.tileH),r=Math.ceil((e.p.x-e.p.cx+e.p.w-n.x)/n.tileW),a=Math.ceil((e.p.y-e.p.cy+e.p.h-n.y)/n.tileH),h=this.collisionObject,l=this.collisionNormal;l.collided=!1;for(var c=o;a>=c;c++)for(var u=s;r>=u;u++)this.tilePresent(u,c)&&(h.p.x=u*n.tileW+n.x+n.tileW/2,h.p.y=c*n.tileH+n.y+n.tileH/2,i=t.collision(e,h),i&&i.magnitude>0&&(!l.collided||l.magnitude<i.magnitude)&&(l.collided=!0,l.separate[0]=i.separate[0],l.separate[1]=i.separate[1],l.magnitude=i.magnitude,l.distance=i.distance,l.normalX=i.normalX,l.normalY=i.normalY,l.tileX=u,l.tileY=c,l.tile=this.getTile(u,c)));return l.collided?l:!1},prerenderBlock:function(t,e){var i=this.p,n=i.tiles,s=this.sheet(),o=t*i.blockTileW,r=e*i.blockTileH;if(!(0>o||o>=this.p.cols||0>r||r>=this.p.rows)){var a=document.createElement("canvas"),h=a.getContext("2d");a.width=i.blockW,a.height=i.blockH,this.blocks[e]=this.blocks[e]||{},this.blocks[e][t]=a;for(var l=0;i.blockTileH>l;l++)if(n[l+r])for(var c=0;i.blockTileW>c;c++)this.drawableTile(n[l+r][c+o])&&s.draw(h,c*i.tileW,l*i.tileH,n[l+r][c+o])}},drawBlock:function(t,e,i){var n=this.p,s=Math.floor(e*n.blockW+n.x),o=Math.floor(i*n.blockH+n.y);this.blocks[i]&&this.blocks[i][e]||this.prerenderBlock(e,i),this.blocks[i]&&this.blocks[i][e]&&t.drawImage(this.blocks[i][e],s,o)},draw:function(e){for(var i=this.p,n=this.stage.viewport,s=n?n.scale:1,o=n?n.x:0,r=n?n.y:0,a=t.width/s,h=t.height/s,l=Math.floor((o-i.x)/i.blockW),c=Math.floor((r-i.y)/i.blockH),u=Math.floor((o+a-i.x)/i.blockW),p=Math.floor((r+h-i.y)/i.blockH),d=c;p>=d;d++)for(var f=l;u>=f;f++)this.drawBlock(e,f,d)}}),t.gravityY=9.8*100,t.gravityX=0,t.dx=.05,t.component("2d",{added:function(){var e=this.entity;t._defaults(e.p,{vx:0,vy:0,ax:0,ay:0,gravity:1,collisionMask:t.SPRITE_DEFAULT}),e.on("step",this,"step"),e.on("hit",this,"collision")},collision:function(t){var e=this.entity,i=e.p;t.impact=0;var n=Math.abs(i.vx),s=Math.abs(i.vy);i.x-=t.separate[0],i.y-=t.separate[1],-.3>t.normalY&&(i.vy>0&&(i.vy=0),t.impact=s,e.trigger("bump.bottom",t)),t.normalY>.3&&(0>i.vy&&(i.vy=0),t.impact=s,e.trigger("bump.top",t)),-.3>t.normalX&&(i.vx>0&&(i.vx=0),t.impact=n,e.trigger("bump.right",t)),t.normalX>.3&&(0>i.vx&&(i.vx=0),t.impact=n,e.trigger("bump.left",t))},step:function(e){for(var i=this.entity.p,n=e;n>0;)e=Math.min(1/30,n),i.vx+=i.ax*e+t.gravityX*e*i.gravity,i.vy+=i.ay*e+t.gravityY*e*i.gravity,i.x+=i.vx*e,i.y+=i.vy*e,this.entity.stage.collide(this.entity),n-=e}}),t.component("aiBounce",{added:function(){this.entity.on("bump.right",this,"goLeft"),this.entity.on("bump.left",this,"goRight")},goLeft:function(t){this.entity.p.vx=-t.impact},goRight:function(t){this.entity.p.vx=t.impact}})},Quintus.Anim=function(t){t._animations={},t.animations=function(e,i){t._animations[e]||(t._animations[e]={}),t._extend(t._animations[e],i)},t.animation=function(e,i){return t._animations[e]&&t._animations[e][i]},t.component("animation",{added:function(){var t=this.entity.p;t.animation=null,t.animationPriority=-1,t.animationFrame=0,t.animationTime=0,this.entity.on("step",this,"step")},extend:{play:function(t,e){this.animation.play(t,e)}},step:function(e){var i=this.entity,n=i.p;if(n.animation){var s=t.animation(n.sprite,n.animation),o=s.rate||n.rate,r=0;if(n.animationTime+=e,n.animationChanged?n.animationChanged=!1:(n.animationTime+=e,n.animationTime>o&&(r=Math.floor(n.animationTime/o),n.animationTime-=r*o,n.animationFrame+=r)),r>0){if(n.animationFrame>=s.frames.length){if(s.loop===!1||s.next)return n.animationFrame=s.frames.length-1,i.trigger("animEnd"),i.trigger("animEnd."+n.animation),n.animation=null,n.animationPriority=-1,s.trigger&&i.trigger(s.trigger,s.triggerData),s.next&&this.play(s.next,s.nextPriority),void 0;i.trigger("animLoop"),i.trigger("animLoop."+n.animation),n.animationFrame=n.animationFrame%s.frames.length}i.trigger("animFrame")}n.sheet=s.sheet||n.sheet,n.frame=s.frames[n.animationFrame]}},play:function(t,e){var i=this.entity,n=i.p;e=e||0,t!==n.animation&&e>=n.animationPriority&&(n.animation=t,n.animationChanged=!0,n.animationTime=0,n.animationFrame=0,n.animationPriority=e,i.trigger("anim"),i.trigger("anim."+n.animation))}}),t.Sprite.extend("Repeater",{init:function(e){this._super(t._defaults(e,{speedX:1,speedY:1,repeatY:!0,repeatX:!0,type:0})),this.p.repeatW=this.p.repeatW||this.p.w,this.p.repeatH=this.p.repeatH||this.p.h},draw:function(e){var i,n,s,o=this.p,r=this.asset(),a=this.sheet(),h=this.stage.viewport?this.stage.viewport.scale:1,l=this.stage.viewport?this.stage.viewport.x:0,c=this.stage.viewport?this.stage.viewport.y:0,u=o.x+l*this.p.speedX,p=o.y+c*this.p.speedY;for(o.repeatX?(i=Math.floor(-u%o.repeatW),i>0&&(i-=o.repeatW)):i=o.x-l,o.repeatY?(n=Math.floor(-p%o.repeatH),n>0&&(n-=o.repeatH)):n=o.y-c,s=i;t.height/h>n;){for(i=s;t.width/h>i&&(a?a.draw(e,Math.floor(i+l),Math.floor(n+c),o.frame):e.drawImage(r,Math.floor(i+l),Math.floor(n+c)),i+=o.repeatW,o.repeatX););if(n+=o.repeatH,!o.repeatY)break}}}),t.Tween=t.Class.extend({init:function(e,i,n,s,o){t._isObject(s)&&(o=s,s=t.Easing.Linear),t._isObject(n)&&(o=n,n=1),this.entity=e,this.duration=n||1,this.time=0,this.options=o||{},this.delay=this.options.delay||0,this.easing=s||this.options.easing||t.Easing.Linear,this.startFrame=t._loopFrame+1,this.properties=i,this.start={},this.diff={}},step:function(e){var i;if(this.startFrame>t._loopFrame)return!0;if(this.delay>=e)return this.delay-=e,!0;if(this.delay>0&&(e-=this.delay,this.delay=0),0===this.time){var n=this.entity,s=this.properties;this.p=n instanceof t.Stage?n.viewport:n.p;for(i in s)this.start[i]=this.p[i],t._isUndefined(this.start[i])||(this.diff[i]=s[i]-this.start[i])}this.time+=e;var o=Math.min(1,this.time/this.duration),r=this.easing(o);for(i in this.start)t._isUndefined(this.p[i])||(this.p[i]=this.start[i]+this.diff[i]*r);return o>=1&&this.options.callback&&this.options.callback.apply(this.entity),1>o}}),t.Easing={Linear:function(t){return t},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return 1>(t*=2)?.5*t*t:-.5*(--t*(t-2)-1)}}},t.component("tween",{added:function(){this._tweens=[],this.entity.on("step",this,"step")},extend:{animate:function(e,i,n,s){return this.tween._tweens.push(new t.Tween(this,e,i,n,s)),this},chain:function(e,i,n,s){t._isObject(n)&&(s=n,n=t.Easing.Linear);var o=this.tween._tweens.length;if(o>0){var r=this.tween._tweens[o-1];s=s||{},s.delay=r.duration-r.time+r.delay}return this.animate(e,i,n,s),this},stop:function(){return this.tween._tweens.length=0,this}},step:function(t){for(var e=0;this._tweens.length>e;e++)this._tweens[e].step(t)||(this._tweens.splice(e,1),e--)}})},Quintus.Audio=function(t){t.audio={channels:[],channelMax:t.options.channelMax||10,active:{},play:function(){}},t.hasWebAudio="undefined"!=typeof AudioContext||"undefined"!=typeof webkitAudioContext,t.hasWebAudio&&(t.audioContext="undefined"!=typeof AudioContext?new AudioContext:new window.webkitAudioContext),t.enableSound=function(){return t.hasWebAudio?t.audio.enableWebAudioSound():t.audio.enableHTML5Sound(),t},t.audio.enableWebAudioSound=function(){t.audio.type="WebAudio",t.audio.soundID=0,t.audio.playingSounds={},t.audio.removeSound=function(e){delete t.audio.playingSounds[e]},t.audio.play=function(e,i){var n=(new Date).getTime();if(!(t.audio.active[e]&&t.audio.active[e]>n)){i&&i.debounce?t.audio.active[e]=n+i.debounce:delete t.audio.active[e];var s=t.audio.soundID++,o=t.audioContext.createBufferSource();o.buffer=t.asset(e),o.connect(t.audioContext.destination),i&&i.loop?o.loop=!0:setTimeout(function(){t.audio.removeSound(s)},1e3*o.buffer.duration),o.assetName=e,o.start?o.start(0):o.noteOn(0),t.audio.playingSounds[s]=o}},t.audio.stop=function(e){for(var i in t.audio.playingSounds){var n=t.audio.playingSounds[i];e&&e!==n.assetName||(n.stop?n.stop(0):n.noteOff(0))}}},t.audio.enableHTML5Sound=function(){t.audio.type="HTML5";for(var e=0;t.audio.channelMax>e;e++)t.audio.channels[e]={},t.audio.channels[e].channel=new Audio,t.audio.channels[e].finished=-1;t.audio.play=function(e,i){var n=(new Date).getTime();if(!(t.audio.active[e]&&t.audio.active[e]>n)){i&&i.debounce?t.audio.active[e]=n+i.debounce:delete t.audio.active[e];for(var s=0;t.audio.channels.length>s;s++)if(!t.audio.channels[s].loop&&n>t.audio.channels[s].finished){t.audio.channels[s].channel.src=t.asset(e).src,i&&i.loop?(t.audio.channels[s].loop=!0,t.audio.channels[s].channel.loop=!0):t.audio.channels[s].finished=n+1e3*t.asset(e).duration,t.audio.channels[s].channel.load(),t.audio.channels[s].channel.play();break}}},t.audio.stop=function(e){for(var i=e?t.asset(e).src:null,n=(new Date).getTime(),s=0;t.audio.channels.length>s;s++)i&&t.audio.channels[s].channel.src!==i||!(t.audio.channels[s].loop||t.audio.channels[s].finished>=n)||(t.audio.channels[s].channel.pause(),t.audio.channels[s].loop=!1)}}},Quintus.Input=function(t){var e={LEFT:37,RIGHT:39,SPACE:32,UP:38,DOWN:40,Z:90,X:88},i={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down",SPACE:"fire",Z:"fire",X:"action"},n=[["left","<"],["right",">"],[],["action","b"],["fire","a"]],s=["up","right","down","left"];t.inputs={},t.joypad={};var o=!!("ontouchstart"in window);t.canvasToStageX=function(e,i){return e=e/t.cssWidth*t.width,i.viewport&&(e/=i.viewport.scale,e+=i.viewport.x),e},t.canvasToStageY=function(e,i){return e=e/t.cssWidth*t.width,i.viewport&&(e/=i.viewport.scale,e+=i.viewport.y),e},t.InputSystem=t.Evented.extend({keys:{},keypad:{},keyboardEnabled:!1,touchEnabled:!1,joypadEnabled:!1,bindKey:function(i,n){t.input.keys[e[i]||i]=n},keyboardControls:function(e){e=e||i,t._each(e,function(t,e){this.bindKey(e,t)},t.input),this.enableKeyboard()},enableKeyboard:function(){return this.keyboardEnabled?!1:(t.el.tabIndex=0,t.el.style.outline=0,t.el.addEventListener("keydown",function(e){if(t.input.keys[e.keyCode]){var i=t.input.keys[e.keyCode];t.inputs[i]=!0,t.input.trigger(i),t.input.trigger("keydown",e.keyCode)}e.preventDefault()},!1),t.el.addEventListener("keyup",function(e){if(t.input.keys[e.keyCode]){var i=t.input.keys[e.keyCode];t.inputs[i]=!1,t.input.trigger(i+"Up"),t.input.trigger("keyup",e.keyCode)}e.preventDefault()},!1),this.keyboardEnabled=!0,void 0)},_containerOffset:function(){t.input.offsetX=0,t.input.offsetY=0;var e=t.el;do t.input.offsetX+=e.offsetLeft,t.input.offsetY+=e.offsetTop;while(e=e.offsetParent)},touchLocation:function(e){var i,n,s=(t.el,e.offsetX),o=e.offsetY;return(t._isUndefined(s)||t._isUndefined(o))&&(s=e.layerX,o=e.layerY),(t._isUndefined(s)||t._isUndefined(o))&&(void 0===t.input.offsetX&&t.input._containerOffset(),s=e.pageX-t.input.offsetX,o=e.pageY-t.input.offsetY),i=t.width*s/t.cssWidth,n=t.height*o/t.cssHeight,{x:i,y:n}},touchControls:function(e){function i(i){for(var n=t.input.touchLocation(i),s=0,o=e.controls.length;o>s;s++)if(n.x<e.unit*(s+1))return e.controls[s][0]}function s(n){var s,o,r,a,h,l={};for(s=0,o=e.controls.length;o>s;s++)h=e.controls[s][0],t.inputs[h]&&(l[h]=!0),t.inputs[h]=!1;var c=n.touches?n.touches:[n];for(s=0,o=c.length;o>s;s++)r=c[s],a=i(r),a&&(t.inputs[a]=!0,l[a]?delete l[a]:t.input.trigger(a));for(h in l)t.input.trigger(h+"Up");return null}return this.touchEnabled?!1:o?(t.input.keypad=e=t._extend({left:0,gutter:10,controls:n,width:t.width,bottom:t.height},e),e.unit=e.width/e.controls.length,e.size=e.unit-2*e.gutter,this.touchDispatchHandler=function(t){s(t),t.preventDefault()},t._each(["touchstart","touchend","touchmove","touchcancel"],function(e){t.el.addEventListener(e,this.touchDispatchHandler)},this),this.touchEnabled=!0,void 0):!1},disableTouchControls:function(){t._each(["touchstart","touchend","touchmove","touchcancel"],function(e){t.el.removeEventListener(e,this.touchDispatchHandler)},this),t.el.removeEventListener("touchstart",this.joypadStart),t.el.removeEventListener("touchmove",this.joypadMove),t.el.removeEventListener("touchend",this.joypadEnd),t.el.removeEventListener("touchcancel",this.joypadEnd),this.touchEnabled=!1},joypadControls:function(e){if(this.joypadEnabled)return!1;if(!o)return!1;var i=t.joypad=t._defaults(e||{},{size:50,trigger:20,center:25,color:"#CCC",background:"#000",alpha:.5,zone:t.width/2,joypadTouch:null,inputs:s,triggers:[]});this.joypadStart=function(e){if(null===i.joypadTouch){var n=e.changedTouches[0],s=t.input.touchLocation(n);s.x<i.zone&&(i.joypadTouch=n.identifier,i.centerX=s.x,i.centerY=s.y,i.x=null,i.y=null)}},this.joypadMove=function(e){if(null!==i.joypadTouch)for(var n=e,s=0,o=n.changedTouches.length;o>s;s++){var r=n.changedTouches[s];if(r.identifier===i.joypadTouch){var a=t.input.touchLocation(r),h=a.x-i.centerX,l=a.y-i.centerY,c=Math.sqrt(h*h+l*l),u=Math.max(1,c/i.size),p=Math.atan2(h,l);u>1&&(h/=u,l/=u,c/=u);for(var d=[-i.trigger>l,h>i.trigger,l>i.trigger,-i.trigger>h],f=0;d.length>f;f++){var g=i.inputs[f];d[f]?(t.inputs[g]=!0,i.triggers[f]||t.input.trigger(g)):(t.inputs[g]=!1,i.triggers[f]&&t.input.trigger(g+"Up"))}t._extend(i,{dx:h,dy:l,x:i.centerX+h,y:i.centerY+l,dist:c,ang:p,triggers:d});break}}e.preventDefault()},this.joypadEnd=function(e){var n=e;if(null!==i.joypadTouch)for(var s=0,o=n.changedTouches.length;o>s;s++){var r=n.changedTouches[s];if(r.identifier===i.joypadTouch){for(var a=0;i.triggers.length>a;a++){var h=i.inputs[a];t.inputs[h]=!1}i.joypadTouch=null;break}}e.preventDefault()},t.el.addEventListener("touchstart",this.joypadStart),t.el.addEventListener("touchmove",this.joypadMove),t.el.addEventListener("touchend",this.joypadEnd),t.el.addEventListener("touchcancel",this.joypadEnd),this.joypadEnabled=!0},mouseControls:function(e){e=e||{};var i=e.stageNum||0,n=e.mouseX||"mouseX",s=e.mouseY||"mouseY",o={};t.el.style.cursor="none",t.inputs[n]=0,t.inputs[s]=0,t._mouseMove=function(e){e.preventDefault();var r=e.touches?e.touches[0]:e,a=(t.el,r.offsetX),h=r.offsetY,l=t.stage(i);(t._isUndefined(a)||t._isUndefined(h))&&(a=r.layerX,h=r.layerY),(t._isUndefined(a)||t._isUndefined(h))&&(void 0===t.input.offsetX&&t.input._containerOffset(),a=r.pageX-t.input.offsetX,h=r.pageY-t.input.offsetY),l&&(o.x=t.canvasToStageX(a,l),o.y=t.canvasToStageY(h,l),t.inputs[n]=o.x,t.inputs[s]=o.y,t.input.trigger("mouseMove",o))},t.el.addEventListener("mousemove",t._mouseMove,!0),t.el.addEventListener("touchstart",t._mouseMove,!0),t.el.addEventListener("touchmove",t._mouseMove,!0)},disableMouseControls:function(){t._mouseMove&&(t.el.removeEventListener("mousemove",t._mouseMove),t.el.style.cursor="inherit",t._mouseMove=null)},drawButtons:function(){var e=t.input.keypad,i=t.ctx;i.save(),i.textAlign="center",i.textBaseline="middle";for(var n=0;e.controls.length>n;n++){var s=e.controls[n];if(s[0]){i.font="bold "+e.size/2+"px arial";var o=n*e.unit+e.gutter,r=e.bottom-e.unit,a=t.inputs[s[0]];i.fillStyle=e.color||"#FFFFFF",i.globalAlpha=a?1:.5,i.fillRect(o,r,e.size,e.size),i.fillStyle=e.text||"#000000",i.fillText(s[1],o+e.size/2,r+e.size/2)}}i.restore()},drawCircle:function(e,i,n,s){var o=t.ctx,r=t.joypad;o.save(),o.beginPath(),o.globalAlpha=r.alpha,o.fillStyle=n,o.arc(e,i,s,0,2*Math.PI,!0),o.closePath(),o.fill(),o.restore()},drawJoypad:function(){var e=t.joypad;null!==e.joypadTouch&&(t.input.drawCircle(e.centerX,e.centerY,e.background,e.size),null!==e.x&&t.input.drawCircle(e.x,e.y,e.color,e.center))
},drawCanvas:function(){this.touchEnabled&&this.drawButtons(),this.joypadEnabled&&this.drawJoypad()}}),t.input=new t.InputSystem,t.controls=function(e){return t.input.keyboardControls(),e?(t.input.touchControls({controls:[[],[],[],["action","b"],["fire","a"]]}),t.input.joypadControls()):t.input.touchControls(),t},t.component("platformerControls",{defaults:{speed:200,jumpSpeed:-300},added:function(){var e=this.entity.p;t._defaults(e,this.defaults),this.entity.on("step",this,"step"),this.entity.on("bump.bottom",this,"landed"),e.landed=0,e.direction="right"},landed:function(){var t=this.entity.p;t.landed=.2},step:function(e){var i=this.entity.p;t.inputs.left?(i.vx=-i.speed,i.direction="left"):t.inputs.right?(i.direction="right",i.vx=i.speed):i.vx=0,i.landed>0&&(t.inputs.up||t.inputs.action)&&(i.vy=i.jumpSpeed,i.landed=-e),i.landed-=e}}),t.component("stepControls",{added:function(){var t=this.entity.p;t.stepDistance||(t.stepDistance=32),t.stepDelay||(t.stepDelay=.2),t.stepWait=0,this.entity.on("step",this,"step"),this.entity.on("hit",this,"collision")},collision:function(){var t=this.entity.p;t.stepping&&(t.stepping=!1,t.x=t.origX,t.y=t.origY)},step:function(e){var i=this.entity.p;i.stepWait-=e,i.stepping&&(i.x+=i.diffX*e/i.stepDelay,i.y+=i.diffY*e/i.stepDelay),i.stepWait>0||(i.stepping&&(i.x=i.destX,i.y=i.destY),i.stepping=!1,i.diffX=0,i.diffY=0,t.inputs.left?i.diffX=-i.stepDistance:t.inputs.right&&(i.diffX=i.stepDistance),t.inputs.up?i.diffY=-i.stepDistance:t.inputs.down&&(i.diffY=i.stepDistance),(i.diffY||i.diffX)&&(i.stepping=!0,i.origX=i.x,i.origY=i.y,i.destX=i.x+i.diffX,i.destY=i.y+i.diffY,i.stepWait=i.stepDelay))}})},Quintus.Scenes=function(t){t.scenes={},t.stages=[],t.Scene=t.Class.extend({init:function(t,e){this.opts=e||{},this.sceneFunc=t}}),t.scene=function(e,i,n){return void 0===i?t.scenes[e]:(t._isFunction(i)&&(i=new t.Scene(i,n)),t.scenes[e]=i,i)},t._nullContainer={c:{x:0,y:0,cx:0,cy:0,angle:0,scale:1},matrix:t.matrix2d()},t.collision=function(){function e(t,e){var i=t[e],n=t[e+1]||t[0];o=-(n[1]-i[1]),r=n[0]-i[0];var s=Math.sqrt(o*o+r*r);s>0&&(o/=s,r/=s)}function i(t){return o*t[0]+r*t[1]}function n(t,n,s){var c,u,p,d,f,g,m,v,y,x,w,b,_,T,S=Number.POSITIVE_INFINITY,E=!1,L=s?l:h;for(a[0]=0,a[1]=0,t.c?_=t.c.points:(_=t.p.points,a[0]+=t.p.x,a[1]+=t.p.y),n.c?T=n.c.points:(T=n.p.points,a[0]+=-n.p.x,a[1]+=-n.p.y),t=t.p,n=n.p,y=0;_.length>y;y++){for(e(_,y),c=i(_[0]),u=c,x=1;_.length>x;x++)v=i(_[x]),c>v&&(c=v),v>u&&(u=v);for(p=i(T[0]),d=p,x=1;T.length>x;x++)v=i(T[x]),p>v&&(p=v),v>d&&(d=v);if(m=i(a),c+=m,u+=m,f=c-d,g=p-u,f>0||g>0)return null;w=-1*(d-c),s&&(w*=-1),b=Math.abs(w),S>b&&(L.distance=w,L.magnitude=b,L.normalX=o,L.normalY=r,L.distance>0&&(L.distance*=-1,L.normalX*=-1,L.normalY*=-1),E=!0,S=b)}return E?L:null}function s(e,i){var s,o,r;return e.p.points||t._generatePoints(e),i.p.points||t._generatePoints(i),t._generateCollisionPoints(e),t._generateCollisionPoints(i),(s=n(e,i))?(o=n(i,e,!0))?(r=o.magnitude<s.magnitude?o:s,0===r.magnitude?!1:(r.separate[0]=r.distance*r.normalX,r.separate[1]=r.distance*r.normalY,r)):!1:!1}var o,r,a=[0,0],h={separate:[]},l={separate:[]};return s}(),t.overlap=function(t,e){var i=t.c||t.p,n=e.c||e.p,s=i.x-i.cx,o=i.y-i.cy,r=n.x-n.cx,a=n.y-n.cy;return!(a>o+i.h||o>a+n.h||r>s+i.w||s>r+n.w)},t.Stage=t.GameObject.extend({defaults:{sort:!1,gridW:400,gridH:400},init:function(e,i){this.scene=e,this.items=[],this.lists={},this.index={},this.removeList=[],this.grid={},this.options=t._extend({},this.defaults),this.scene&&t._extend(this.options,e.opts),i&&t._extend(this.options,i),this.options.sort&&!t._isFunction(this.options.sort)&&(this.options.sort=function(t,e){return(t.p&&t.p.z||-1)-(e.p&&e.p.z||-1)})},destroyed:function(){this.invoke("debind"),this.trigger("destroyed")},loadScene:function(){this.scene&&this.scene.sceneFunc(this)},each:function(t){for(var e=0,i=this.items.length;i>e;e++)t.call(this.items[e],arguments[1],arguments[2])},invoke:function(t){for(var e=0,i=this.items.length;i>e;e++)this.items[e][t].call(this.items[e],arguments[1],arguments[2])},detect:function(t){for(var e=this.items.length-1;e>=0;e--)if(t.call(this.items[e],arguments[1],arguments[2],arguments[3]))return this.items[e];return!1},identify:function(t){for(var e,i=this.items.length-1;i>=0;i--)if(e=t.call(this.items[i],arguments[1],arguments[2],arguments[3]))return e;return!1},addToLists:function(t,e){for(var i=0;t.length>i;i++)this.addToList(t[i],e)},addToList:function(t,e){this.lists[t]||(this.lists[t]=[]),this.lists[t].push(e)},removeFromLists:function(t,e){for(var i=0;t.length>i;i++)this.removeFromList(t[i],e)},removeFromList:function(t,e){var i=this.lists[t].indexOf(e);-1!==i&&this.lists[t].splice(i,1)},insert:function(e,i){return this.items.push(e),e.stage=this,e.container=i,i&&i.children.push(e),e.grid={},t._generatePoints(e),t._generateCollisionPoints(e),e.className&&this.addToList(e.className,e),e.activeComponents&&this.addToLists(e.activeComponents,e),e.p&&(this.index[e.p.id]=e),this.trigger("inserted",e),e.trigger("inserted",this),this.regrid(e),e},remove:function(t){this.delGrid(t),this.removeList.push(t)},forceRemove:function(t){var e=this.items.indexOf(t);if(-1!==e){if(this.items.splice(e,1),t.className&&this.removeFromList(t.className,t),t.activeComponents&&this.removeFromLists(t.activeComponents,t),t.container){var i=t.container.children.indexOf(t);-1!==i&&t.container.children.splice(i,1)}t.destroy&&t.destroy(),t.p.id&&delete this.index[t.p.id],this.trigger("removed",t)}},pause:function(){this.paused=!0},unpause:function(){this.paused=!1},_gridCellCheck:function(e,i,n,s){if(!s||s&e){var o=this.index[i];if(o&&o!==n&&t.overlap(n,o)){var r=t.collision(n,o);return r?(r.obj=o,r):!1}}},gridTest:function(e,i){for(var n,s,o=e.grid,r=o.Y1;o.Y2>=r;r++)if(this.grid[r])for(var a=o.X1;o.X2>=a;a++)if(n=this.grid[r][a],n&&(s=t._detect(n,this._gridCellCheck,this,e,i)))return s;return!1},collisionLayer:function(t){this._collisionLayer=t,this.insert(t)},search:function(t,e){var i;return e=e||t.p&&t.p.collisionMask,this._collisionLayer&&this._collisionLayer.p.type&e&&(i=this._collisionLayer.collide(t))?i:i=this.gridTest(t,e,this._collisionLayer)},_locateObj:{p:{x:0,y:0,w:1,h:1},grid:{}},locate:function(t,e,i){var n=null;return this._locateObj.p.x=t,this._locateObj.p.y=e,this.regrid(this._locateObj,!0),this._collisionLayer&&this._collisionLayer.p.type&i&&(n=this._collisionLayer.collide(this._locateObj)),n||(n=this.gridTest(this._locateObj,i,this._collisionLayer)),n&&n.obj?n.obj:!1},collide:function(t,e){var i,n,s=3;if(e=e||t.p&&t.p.collisionMask,this.regrid(t),this._collisionLayer&&this._collisionLayer.p.type&e)for(;s>0&&(i=this._collisionLayer.collide(t));)i.obj=this._collisionLayer,t.trigger("hit",i),t.trigger("hit.collision",i),this.regrid(t),s--;for(s=3;s>0&&(n=this.gridTest(t,e,this._collisionLayer));){t.trigger("hit",n),t.trigger("hit.sprite",n);var o=n.obj;n.obj=t,n.normalX*=-1,n.normalY*=-1,n.distance=0,n.magnitude=0,n.separate[0]=0,n.separate[1]=0,o.trigger("hit",n),o.trigger("hit.sprite",n),this.regrid(t),s--}return n||i},delGrid:function(t){for(var e=t.grid,i=e.Y1;e.Y2>=i;i++)if(this.grid[i])for(var n=e.X1;e.X2>=n;n++)this.grid[i][n]&&delete this.grid[i][n][t.p.id]},addGrid:function(t){for(var e=t.grid,i=e.Y1;e.Y2>=i;i++){this.grid[i]||(this.grid[i]={});for(var n=e.X1;e.X2>=n;n++)this.grid[i][n]||(this.grid[i][n]={}),this.grid[i][n][t.p.id]=t.p.type}},regrid:function(t,e){if((!this._collisionLayer||t!==this._collisionLayer)&&(t.p.type||e)){var i=t.c||t.p,n=Math.floor((i.x-i.cx)/this.options.gridW),s=Math.floor((i.y-i.cy)/this.options.gridH),o=Math.floor((i.x-i.cx+i.w)/this.options.gridW),r=Math.floor((i.y-i.cy+i.h)/this.options.gridH),a=t.grid;(a.X1!==n||a.X2!==o||a.Y1!==s||a.Y2!==r)&&(void 0!==a.X1&&this.delGrid(t),a.X1=n,a.X2=o,a.Y1=s,a.Y2=r,e||this.addGrid(t))}},updateSprites:function(e,i,n){for(var s,o=0,r=e.length;r>o;o++)s=e[o],(n||!s.container)&&(s.update(i),t._generateCollisionPoints(s),this.regrid(s))},step:function(t){if(this.paused)return!1;if(this.trigger("prestep",t),this.updateSprites(this.items,t),this.trigger("step",t),this.removeList.length>0){for(var e=0,i=this.removeList.length;i>e;e++)this.forceRemove(this.removeList[e]);this.removeList.length=0}this.trigger("poststep",t)},render:function(t){this.options.sort&&this.items.sort(this.options.sort),this.trigger("prerender",t),this.trigger("beforerender",t);for(var e=0,i=this.items.length;i>e;e++){var n=this.items[e];n.container||n.render(t)}this.trigger("render",t),this.trigger("postrender",t)}}),t.activeStage=0,t.StageSelector=t.Class.extend({emptyList:[],init:function(t,e){this.stage=t,this.selector=e,this.items=this.stage.lists[this.selector]||this.emptyList,this.length=this.items.length},each:function(t){for(var e=0,i=this.items.length;i>e;e++)t.call(this.items[e],arguments[1],arguments[2]);return this},invoke:function(t){for(var e=0,i=this.items.length;i>e;e++)this.items[e][t].call(this.items[e],arguments[1],arguments[2]);return this},trigger:function(t,e){this.invoke("trigger",t,e)},destroy:function(){this.invoke("destroy")},detect:function(t){for(var e=0,i=this.items.length;i>e;e++)if(t.call(this.items[e],arguments[1],arguments[2]))return this.items[e];return!1},identify:function(t){for(var e=null,i=0,n=this.items.length;n>i;i++)if(e=t.call(this.items[i],arguments[1],arguments[2]))return e;return!1},_pObject:function(e){t._extend(this.p,e)},_pSingle:function(t,e){this.p[t]=e},set:function(t,e){return void 0===e?this.each(this._pObject,t):this.each(this._pSingle,t,e),this},at:function(t){return this.items[t]},first:function(){return this.items[0]},last:function(){return this.items[this.items.length-1]}}),t.select=function(e,i){return i=void 0===i?t.activeStage:i,i=t.stage(i),t._isNumber(e)?i.index[e]:new t.StageSelector(i,e)},t.stage=function(e){return e=void 0===e?t.activeStage:e,t.stages[e]},t.stageScene=function(e,i,n){t._isString(e)&&(e=t.scene(e)),t._isObject(i)&&(n=i,i=t._popProperty(n,"stage")||e&&e.opts.stage||0),n=t._clone(n);var s=t._popProperty(n,"stageClass")||e&&e.opts.stageClass||t.Stage;return i=t._isUndefined(i)?e&&e.opts.stage||0:i,t.stages[i]&&t.stages[i].destroy(),t.activeStage=i,t.stages[i]=new s(e,n),e&&t.stages[i].loadScene(),t.activeStage=0,t.loop||t.gameLoop(t.stageGameLoop),t.stages[i]},t.stageGameLoop=function(e){var i,n,s;for(0>e&&(e=1/60),e>1/15&&(e=1/15),i=0,n=t.stages.length;n>i;i++)t.activeStage=i,s=t.stage(),s&&s.step(e);for(t.ctx&&t.clear(),i=0,n=t.stages.length;n>i;i++)t.activeStage=i,s=t.stage(),s&&s.render(t.ctx);t.activeStage=0,t.input&&t.ctx&&t.input.drawCanvas(t.ctx)},t.clearStage=function(e){t.stages[e]&&(t.stages[e].destroy(),t.stages[e]=null)},t.clearStages=function(){for(var e=0,i=t.stages.length;i>e;e++)t.stages[e]&&t.stages[e].destroy();t.stages.length=0}},Quintus.Sprites=function(t){return t.Class.extend("SpriteSheet",{init:function(e,i,n){if(!t.asset(i))throw"Invalid Asset:"+i;t._extend(this,{name:e,asset:i,w:t.asset(i).width,h:t.asset(i).height,tilew:64,tileh:64,sx:0,sy:0}),n&&t._extend(this,n),this.cols=this.cols||Math.floor(this.w/this.tilew)},fx:function(t){return Math.floor(t%this.cols*this.tilew+this.sx)},fy:function(t){return Math.floor(Math.floor(t/this.cols)*this.tileh+this.sy)},draw:function(e,i,n,s){e||(e=t.ctx),e.drawImage(t.asset(this.asset),this.fx(s),this.fy(s),this.tilew,this.tileh,Math.floor(i),Math.floor(n),this.tilew,this.tileh)}}),t.sheets={},t.sheet=function(e,i,n){return i?(t.sheets[e]=new t.SpriteSheet(e,i,n),void 0):t.sheets[e]},t.compileSheets=function(e,i){var n=t.asset(i);t._each(n,function(i,n){t.sheet(n,e,i)})},t.SPRITE_NONE=0,t.SPRITE_DEFAULT=1,t.SPRITE_PARTICLE=2,t.SPRITE_ACTIVE=4,t.SPRITE_FRIENDLY=8,t.SPRITE_ENEMY=16,t.SPRITE_POWERUP=32,t.SPRITE_UI=64,t.SPRITE_ALL=65535,t._generatePoints=function(t,e){if(!t.p.points||e){var i=t.p,n=i.w/2,s=i.h/2;i.points=[[-n,-s],[n,-s],[n,s],[-n,s]]}},t._generateCollisionPoints=function(e){if(e.matrix||e.refreshMatrix){e.c||(e.c={points:[]});var i=e.p,n=e.c;if(i.moved||n.origX!==i.x||n.origY!==i.y||n.origScale!==i.scale||n.origScale!==i.angle){n.origX=i.x,n.origY=i.y,n.origScale=i.scale,n.origAngle=i.angle,e.refreshMatrix();var s=e.container||t._nullContainer;n.x=s.matrix.transformX(i.x,i.y),n.y=s.matrix.transformY(i.x,i.y),n.angle=i.angle+s.c.angle,n.scale=(s.c.scale||1)*(i.scale||1);for(var o=1/0,r=1/0,a=-1/0,h=-1/0,l=0;e.p.points.length>l;l++){e.c.points[l]||(e.c.points[l]=[]),e.matrix.transformArr(e.p.points[l],e.c.points[l]);var c=e.c.points[l][0],u=e.c.points[l][1];o>c&&(o=c),c>a&&(a=c),r>u&&(r=u),u>h&&(h=u)}o===a&&(a+=1),r===h&&(h+=1),n.cx=n.x-o,n.cy=n.y-r,n.w=a-o,n.h=h-r}}},t.GameObject.extend("Sprite",{init:function(e,i){this.p=t._extend({x:0,y:0,z:0,angle:0,frame:0,type:t.SPRITE_DEFAULT|t.SPRITE_ACTIVE},i),this.matrix=new t.Matrix2D,this.children=[],t._extend(this.p,e),this.size(),this.p.id=this.p.id||t._uniqueId(),this.c={points:[]},this.refreshMatrix()},size:function(t){!t&&this.p.w&&this.p.h||(this.asset()?(this.p.w=this.asset().width,this.p.h=this.asset().height):this.sheet()&&(this.p.w=this.sheet().tilew,this.p.h=this.sheet().tileh)),this.p.cx=t||void 0===this.p.cx?this.p.w/2:this.p.cx,this.p.cy=t||void 0===this.p.cy?this.p.h/2:this.p.cy},asset:function(e,i){return e?(this.p.asset=e,i&&(this.size(!0),t._generatePoints(this,!0)),void 0):t.asset(this.p.asset)},sheet:function(e,i){return e?(this.p.sheet=e,i&&(this.size(!0),t._generatePoints(this,!0)),void 0):t.sheet(this.p.sheet)},hide:function(){this.p.hidden=!0},show:function(){this.p.hidden=!1},set:function(e){return t._extend(this.p,e),this},_sortChild:function(t,e){return(t.p&&t.p.z||-1)-(e.p&&e.p.z||-1)},_flipArgs:{x:[-1,1],y:[1,-1],xy:[-1,-1]},render:function(e){var i=this.p;i.hidden||(e||(e=t.ctx),this.trigger("predraw",e),e.save(),void 0!==this.p.opacity&&1!==this.p.opacity&&(e.globalAlpha=this.p.opacity),this.matrix.setContextTransform(e),this.p.flip&&e.scale.apply(e,this._flipArgs[this.p.flip]),this.trigger("beforedraw",e),this.draw(e),this.trigger("draw",e),e.restore(),this.p.sort&&this.children.sort(this._sortChild),t._invoke(this.children,"render",e),this.trigger("postdraw",e),t.debug&&this.debugRender(e))},center:function(){this.container?(this.p.x=this.container.p.w/2,this.p.y=this.container.p.h/2):(this.p.x=t.width/2,this.p.y=t.height/2)},draw:function(e){var i=this.p;i.sheet?this.sheet().draw(e,-i.cx,-i.cy,i.frame):i.asset&&e.drawImage(t.asset(i.asset),-i.cx,-i.cy)},debugRender:function(e){this.p.points||t._generatePoints(this),e.save(),this.matrix.setContextTransform(e),e.beginPath(),e.fillStyle=this.p.hit?"blue":"red",e.strokeStyle="#FF0000",e.fillStyle="rgba(0,0,0,0.5)",e.moveTo(this.p.points[0][0],this.p.points[0][1]);for(var i=0;this.p.points.length>i;i++)e.lineTo(this.p.points[i][0],this.p.points[i][1]);if(e.lineTo(this.p.points[0][0],this.p.points[0][1]),e.stroke(),t.debugFill&&e.fill(),e.restore(),this.c){var n=this.c;e.save(),e.globalAlpha=1,e.lineWidth=2,e.strokeStyle="#FF00FF",e.beginPath(),e.moveTo(n.x-n.cx,n.y-n.cy),e.lineTo(n.x-n.cx+n.w,n.y-n.cy),e.lineTo(n.x-n.cx+n.w,n.y-n.cy+n.h),e.lineTo(n.x-n.cx,n.y-n.cy+n.h),e.lineTo(n.x-n.cx,n.y-n.cy),e.stroke(),e.restore()}},update:function(t){this.trigger("prestep",t),this.step&&this.step(t),this.trigger("step",t),this.refreshMatrix(),this.stage&&this.children.length>0&&this.stage.updateSprites(this.children,t,!0)},refreshMatrix:function(){var t=this.p;this.matrix.identity(),this.container&&this.matrix.multiply(this.container.matrix),this.matrix.translate(t.x,t.y),t.scale&&this.matrix.scale(t.scale,t.scale),this.matrix.rotateDeg(t.angle)}}),t.Sprite.extend("MovingSprite",{init:function(e,i){this._super(t._extend({vx:0,vy:0,ax:0,ay:0},e),i)},step:function(t){var e=this.p;e.vx+=e.ax*t,e.vy+=e.ay*t,e.x+=e.vx*t,e.y+=e.vy*t}}),t},Quintus.Touch=function(t){if(t._isUndefined(Quintus.Sprites))throw"Quintus.Touch requires Quintus.Sprites Module";var e=[0],i=0;t.Evented.extend("TouchSystem",{init:function(){var e=this;this.boundTouch=function(t){e.touch(t)},this.boundDrag=function(t){e.drag(t)},this.boundEnd=function(t){e.touchEnd(t)},t.el.addEventListener("touchstart",this.boundTouch),t.el.addEventListener("mousedown",this.boundTouch),t.el.addEventListener("touchmove",this.boundDrag),t.el.addEventListener("mousemove",this.boundDrag),t.el.addEventListener("touchend",this.boundEnd),t.el.addEventListener("mouseup",this.boundEnd),t.el.addEventListener("touchcancel",this.boundEnd),this.touchPos=new t.Evented,this.touchPos.grid={},this.touchPos.p={w:1,h:1,cx:0,cy:0},this.activeTouches={},this.touchedObjects={}},destroy:function(){t.el.removeEventListener("touchstart",this.boundTouch),t.el.removeEventListener("mousedown",this.boundTouch),t.el.removeEventListener("touchmove",this.boundDrag),t.el.removeEventListener("mousemove",this.boundDrag),t.el.removeEventListener("touchend",this.boundEnd),t.el.removeEventListener("mouseup",this.boundEnd),t.el.removeEventListener("touchcancel",this.boundEnd)},normalizeTouch:function(e,i){var n=e.offsetX,s=e.offsetY;if((t._isUndefined(n)||t._isUndefined(s))&&(n=e.layerX,s=e.layerY),t._isUndefined(n)||t._isUndefined(s)){if(void 0===t.touch.offsetX){t.touch.offsetX=0,t.touch.offsetY=0;var o=t.el;do t.touch.offsetX+=o.offsetLeft,t.touch.offsetY+=o.offsetTop;while(o=o.offsetParent)}n=e.pageX-t.touch.offsetX,s=e.pageY-t.touch.offsetY}return this.touchPos.p.ox=this.touchPos.p.px=n/t.cssWidth*t.width,this.touchPos.p.oy=this.touchPos.p.py=s/t.cssHeight*t.height,i.viewport&&(this.touchPos.p.px/=i.viewport.scale,this.touchPos.p.py/=i.viewport.scale,this.touchPos.p.px+=i.viewport.x,this.touchPos.p.py+=i.viewport.y),this.touchPos.p.x=this.touchPos.p.px,this.touchPos.p.y=this.touchPos.p.py,this.touchPos.obj=null,this.touchPos},touch:function(n){for(var s=n.changedTouches||[n],o=0;s.length>o;o++)for(var r=0;e.length>r;r++){var a=s[o],h=t.stage(e[r]);if(h){a.identifier=a.identifier||0;var l=this.normalizeTouch(a,h);h.regrid(l,!0);var c,u=h.search(l,i);if((u||r===e.length-1)&&(c=u&&u.obj,l.obj=c,this.trigger("touch",l)),c&&!this.touchedObjects[c]){this.activeTouches[a.identifier]={x:l.p.px,y:l.p.py,origX:c.p.x,origY:c.p.y,sx:l.p.ox,sy:l.p.oy,identifier:a.identifier,obj:c,stage:h},this.touchedObjects[c.p.id]=!0,c.trigger("touch",this.activeTouches[a.identifier]);break}}}},drag:function(t){for(var e=t.changedTouches||[t],i=0;e.length>i;i++){var n=e[i];n.identifier=n.identifier||0;var s=this.activeTouches[n.identifier],o=s&&s.stage;if(s){var r=this.normalizeTouch(n,o);s.x=r.p.px,s.y=r.p.py,s.dx=r.p.ox-s.sx,s.dy=r.p.oy-s.sy,s.obj.trigger("drag",s)}}t.preventDefault()},touchEnd:function(t){for(var e=t.changedTouches||[t],i=0;e.length>i;i++){var n=e[i];n.identifier=n.identifier||0;var s=this.activeTouches[n.identifier];s&&(s.obj.trigger("touchEnd",s),delete this.touchedObjects[s.obj.p.id],this.activeTouches[n.identifier]=null)}t.preventDefault()}}),t.touch=function(n,s){return t.untouch(),i=n||t.SPRITE_UI,e=s||[2,1,0],t._isArray(e)||(e=[e]),t._touch||(t.touchInput=new t.TouchSystem),t},t.untouch=function(){return t.touchInput&&(t.touchInput.destroy(),delete t.touchInput),t}},Quintus.UI=function(t){if(t._isUndefined(Quintus.Touch))throw"Quintus.UI requires Quintus.Touch Module";t.UI={},t.UI.roundRect=function(t,e){t.beginPath(),t.moveTo(-e.cx+e.radius,-e.cy),t.lineTo(-e.cx+e.w-e.radius,-e.cy),t.quadraticCurveTo(-e.cx+e.w,-e.cy,-e.cx+e.w,-e.cy+e.radius),t.lineTo(-e.cx+e.w,-e.cy+e.h-e.radius),t.quadraticCurveTo(-e.cx+e.w,-e.cy+e.h,-e.cx+e.w-e.radius,-e.cy+e.h),t.lineTo(-e.cx+e.radius,-e.cy+e.h),t.quadraticCurveTo(-e.cx,-e.cy+e.h,-e.cx,-e.cy+e.h-e.radius),t.lineTo(-e.cx,-e.cy+e.radius),t.quadraticCurveTo(-e.cx,-e.cy,-e.cx+e.radius,-e.cy),t.closePath()},t.UI.Container=t.Sprite.extend("UI.Container",{init:function(e){var i,n=t._clone(e||{});e&&t._isString(e.w)&&(i=e.w.match(/^[0-9]+%$/))&&(n.w=parseInt(e.w,10)*t.width/100,n.x=t.width/2-n.w/2),e&&t._isString(e.h)&&(i=e.h.match(/^[0-9]+%$/))&&(n.h=parseInt(e.h,10)*t.height/100,n.y=t.height/2-n.h/2),this._super(n,{opacity:1,hidden:!1,fill:null,highlight:null,radius:5,stroke:"#000",border:!1,shadow:!1,shadowColor:!1,type:t.SPRITE_NONE})},insert:function(t){return this.stage.insert(t,this),t},fit:function(t,e){if(0!==this.children.length){void 0===t&&(t=0),void 0===e&&(e=t);for(var i=1/0,n=1/0,s=-1/0,o=-1/0,r=0;this.children.length>r;r++){var a=this.children[r],h=a.p.x-a.p.cx,l=a.p.y-a.p.cy,c=a.p.x-a.p.cx+a.p.w,u=a.p.y-a.p.cy+a.p.h;i>h&&(i=h),n>l&&(n=l),c>s&&(s=c),u>o&&(o=u)}this.p.cx=-i+e,this.p.cy=-n+t,this.p.w=s-i+2*e,this.p.h=o-n+2*t}},addShadow:function(e){if(this.p.shadow){var i=t._isNumber(this.p.shadow)?this.p.shadow:5;e.shadowOffsetX=i,e.shadowOffsetY=i,e.shadowColor=this.p.shadowColor||"rgba(0,0,50,0.1)"}},clearShadow:function(t){t.shadowColor="transparent"},drawRadius:function(e){t.UI.roundRect(e,this.p),this.addShadow(e),e.fill(),this.p.border&&(this.clearShadow(e),e.lineWidth=this.p.border,e.stroke())},drawSquare:function(t){this.addShadow(t),this.p.fill&&t.fillRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h),this.p.border&&(this.clearShadow(t),t.lineWidth=this.p.border,t.strokeRect(-this.p.cx,-this.p.cy,this.p.w,this.p.h))},draw:function(t){return this.p.hidden?!1:((this.p.border||this.p.fill)&&(t.globalAlpha=this.p.opacity,t.fillStyle=1===this.p.frame&&this.p.highlight?this.p.highlight:this.p.fill,t.strokeStyle=this.p.stroke,this.p.radius>0?this.drawRadius(t):this.drawSquare(t)),void 0)}}),t.UI.Text=t.Sprite.extend("UI.Text",{init:function(e,i){this._super(t._defaults(e||{},i),{type:t.SPRITE_UI,size:24}),this.p.label&&this.calcSize()},calcSize:function(){this.setFont(t.ctx),this.splitLabel=this.p.label.split("\n");for(var e="",i=0;this.splitLabel.length>i;i++)this.splitLabel[i].length>e.length&&(e=this.splitLabel[i]);var n=t.ctx.measureText(e);this.p.h=1.2*(this.p.size||24)*this.splitLabel.length,this.p.w=n.width,this.p.cx=this.p.w/2,this.p.cy=this.p.h/2},prerender:function(){this.p.oldLabel!==this.p.label&&(this.p.oldLabel=this.p.label,this.calcSize(),this.el.width=this.p.w,this.el.height=4*this.p.h,this.ctx.clearRect(0,0,this.p.w,this.p.h),this.ctx.fillStyle="#FF0",this.ctx.fillRect(0,0,this.p.w,this.p.h/2),this.setFont(this.ctx),this.ctx.fillText(this.p.label,0,0))},draw:function(t){if(0!==this.p.opacity){this.p.oldLabel!==this.p.label&&this.calcSize(),this.setFont(t),void 0!==this.p.opacity&&(t.globalAlpha=this.p.opacity);for(var e=0;this.splitLabel.length>e;e++)"center"===this.p.align?t.fillText(this.splitLabel[e],0,-this.p.cy+1.2*e*this.p.size):"right"===this.p.align?t.fillText(this.splitLabel[e],this.p.cx,-this.p.cy+1.2*e*this.p.size):t.fillText(this.splitLabel[e],-this.p.cx,-this.p.cy+1.2*e*this.p.size)}},asset:function(){return this.el},setFont:function(t){t.textBaseline="top",t.font=this.font(),t.fillStyle=this.p.color||"black",t.textAlign=this.p.align||"left"},font:function(){return this.fontString?this.fontString:(this.fontString=(this.p.weight||"800")+" "+(this.p.size||24)+"px "+(this.p.family||"Arial"),this.fontString)}}),t.UI.Button=t.UI.Container.extend("UI.Button",{init:function(e,i){if(this._super(t._defaults(e,{type:t.SPRITE_UI|t.SPRITE_DEFAULT})),this.p.label&&(!this.p.w||!this.p.h)){t.ctx.save(),this.setFont(t.ctx);var n=t.ctx.measureText(this.p.label);t.ctx.restore(),this.p.h||(this.p.h=44),this.p.w||(this.p.w=n.width+20)}isNaN(this.p.cx)&&(this.p.cx=this.p.w/2),isNaN(this.p.cy)&&(this.p.cy=this.p.h/2),this.callback=i,this.on("touch",this,"highlight"),this.on("touchEnd",this,"push")},highlight:function(){(!this.sheet()||this.sheet().frames>1)&&(this.p.frame=1)},push:function(){this.p.frame=0,this.callback&&this.callback(),this.trigger("click")},draw:function(e){this._super(e),(this.p.asset||this.p.sheet)&&t.Sprite.prototype.draw.call(this,e),this.p.label&&(e.save(),this.setFont(e),e.fillText(this.p.label,0,0),e.restore())},setFont:function(t){t.textBaseline="middle",t.font=this.p.font||"400 24px arial",t.fillStyle=this.p.fontColor||"black",t.textAlign="center"}}),t.UI.IFrame=t.Sprite.extend("UI.IFrame",{init:function(e){this._super(e,{opacity:1,type:t.SPRITE_UI|t.SPRITE_DEFAULT}),t.wrapper.style.overflow="hidden",this.iframe=document.createElement("IFRAME"),this.iframe.setAttribute("src",this.p.url),this.iframe.style.position="absolute",this.iframe.style.zIndex=500,this.iframe.setAttribute("width",this.p.w),this.iframe.setAttribute("height",this.p.h),this.iframe.setAttribute("frameborder",0),this.p.background&&(this.iframe.style.backgroundColor=this.p.background),t.wrapper.appendChild(this.iframe),this.on("inserted",function(t){this.positionIFrame(),t.on("destroyed",this,"remove")})},positionIFrame:function(){var t=this.p.x,e=this.p.y;this.stage.viewport&&(t-=this.stage.viewport.x,e-=this.stage.viewport.y),(this.oldX!==t||this.oldY!==e||this.oldOpacity!==this.p.opacity)&&(this.iframe.style.top=e-this.p.cy+"px",this.iframe.style.left=t-this.p.cx+"px",this.iframe.style.opacity=this.p.opacity,this.oldX=t,this.oldY=e,this.oldOpacity=this.p.opacity)},step:function(t){this._super(t),this.positionIFrame()},remove:function(){this.iframe&&(t.wrapper.removeChild(this.iframe),this.iframe=null)}}),t.UI.HTMLElement=t.Sprite.extend("UI.HTMLElement",{init:function(e){this._super(e,{opacity:1,type:t.SPRITE_UI}),t.wrapper.style.overflow="hidden",this.el=document.createElement("div"),this.el.innerHTML=this.p.html,t.wrapper.appendChild(this.el),this.on("inserted",function(t){this.position(),t.on("destroyed",this,"remove"),t.on("clear",this,"remove")})},position:function(){},step:function(t){this._super(t),this.position()},remove:function(){this.el&&(t.wrapper.removeChild(this.el),this.el=null)}}),t.UI.VerticalLayout=t.Sprite.extend("UI.VerticalLayout",{init:function(t){this.children=[],this._super(t,{type:0})},insert:function(t){return this.stage.insert(t,this),this.relayout(),t},relayout:function(){for(var t=0,e=0;this.children.length>e;e++)t+=this.children[e].p.h||0;this.p.h-t}})};